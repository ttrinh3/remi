name: Request Reviewers
on:
  pull_request:
    types:
      - opened

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Set up environment variables
        id: env
        run: |
          echo "REPO_OWNER=${{ github.repository_owner }}" >> $GITHUB_ENV

      - name: Request Reviewers
        id: reviewers
        run: |
          # Define branch patterns and reviewers using workflow inputs
          # Each branch pattern is associated with a list of reviewers

          # Example branch patterns and reviewers
          - name: main
            reviewers: ttrinh3
          - name: feature/*
            reviewers: skatepoiser

          # Get the target branch of the pull request
          target_branch=$(jq --raw-output .pull_request.base.ref "$GITHUB_EVENT_PATH")

          # Loop through branch patterns and check if the target branch matches
          for reviewer_entry in ${{ toJSON(reviewers) }}; do
            branch_pattern=$(echo $reviewer_entry | jq -r '.name')
            if [[ $target_branch == $branch_pattern ]]; then
              reviewers=$(echo $reviewer_entry | jq -r '.reviewers | join(",")')
              break
            fi
          done

          # Request reviewers
          if [[ -n $reviewers ]]; then
            for reviewer in $(echo $reviewers | tr ',' '\n'); do
              echo "Requesting review from $reviewer"
              # Request review using the GitHub API
              curl -sSL -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/requested_reviewers" \
                -d "{\"reviewers\":[\"$reviewer\"]}"
            done
          fi
